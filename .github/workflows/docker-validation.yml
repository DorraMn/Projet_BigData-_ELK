# ============================================
# Docker Compose Validation Workflow
# ============================================
# 
# VÃ©rifie que docker-compose.yml est valide
# et que tous les services dÃ©marrent correctement
# ============================================

name: ðŸ³ Docker Compose Validation

on:
  push:
    paths:
      - 'docker-compose.yml'
      - 'webapp/Dockerfile'
      - 'webapp/Dockerfile.frontend'
      - 'webapp/requirements.txt'
  pull_request:
    paths:
      - 'docker-compose.yml'
      - 'webapp/Dockerfile'
      - 'webapp/Dockerfile.frontend'

jobs:
  validate:
    name: ðŸ” Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6
      
      - name: ðŸ”§ Create .env file
        run: |
          cat > .env << EOF
          ELASTIC_VERSION=8.10.3
          KIBANA_VERSION=8.10.3
          LOGSTASH_VERSION=8.10.3
          FLASK_ENV=testing
          FLASK_RUN_PORT=8000
          JWT_SECRET_KEY=test-secret-key
          JWT_EXPIRATION_HOURS=24
          ADMIN_USERNAME=admin
          ADMIN_PASSWORD=admin123
          EOF
      
      - name: âœ… Validate docker-compose.yml syntax
        run: |
          docker compose config --quiet
          echo "âœ… docker-compose.yml syntax is valid"
      
      - name: ðŸ—ï¸ Build all images
        run: |
          docker compose build --no-cache
          echo "âœ… All images built successfully"
      
      - name: ðŸš€ Start services
        run: |
          docker compose up -d elasticsearch mongodb redis
          echo "â³ Waiting for services to be healthy..."
          sleep 30
      
      - name: ðŸ§ª Test Elasticsearch
        run: |
          curl -s http://localhost:9200/_cluster/health || echo "âš ï¸ Elasticsearch not ready"
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans
