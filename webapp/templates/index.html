<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring SaaS - Dashboard Principal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <div class="logo">‚ö°</div>
                <span>LogStream Studio</span>
            </a>
            <ul class="nav-links">
                <li><a href="/">Dashboard</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/dashboard">Fichiers</a></li>
                <li><a href="/health">Health Check</a></li>
                <li><a href="/search">Recherche</a></li>
                <li><a href="http://localhost:5601/app/dashboards#/view/ecommerce-dashboard" target="_blank">Kibana</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <div class="hero" style="padding: 2rem 0; text-align: center;">
            <h1>üìä Dashboard Principal</h1>
            <p class="mb-3" style="color: var(--gray-600);">
                Vue d'ensemble de votre infrastructure de monitoring en temps r√©el
            </p>
        </div>

        <!-- KPIs Grid -->
        <div class="grid grid-4 mt-3">
            <!-- Total Logs -->
            <div class="stat-card">
                <div class="stat-icon success">üìÑ</div>
                <div class="stat-value" id="kpi-total-logs">
                    <div class="spinner"></div>
                </div>
                <div class="stat-label">Total Logs</div>
            </div>

            <!-- Logs Today -->
            <div class="stat-card">
                <div class="stat-icon primary">üìÖ</div>
                <div class="stat-value" id="kpi-logs-today">
                    <div class="spinner"></div>
                </div>
                <div class="stat-label">Logs Aujourd'hui</div>
            </div>

            <!-- Errors -->
            <div class="stat-card">
                <div class="stat-icon danger">‚ö†Ô∏è</div>
                <div class="stat-value" id="kpi-errors">
                    <div class="spinner"></div>
                </div>
                <div class="stat-label">Erreurs</div>
            </div>

            <!-- Files Uploaded -->
            <div class="stat-card">
                <div class="stat-icon warning">üì§</div>
                <div class="stat-value" id="kpi-files">
                    <div class="spinner"></div>
                </div>
                <div class="stat-label">Fichiers Upload√©s</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card mt-4">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üìà √âvolution des Logs (7 derniers jours)</h2>
                <button onclick="refreshData()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                    üîÑ Actualiser
                </button>
            </div>
            <div style="position: relative; height: 350px;">
                <canvas id="logsChart"></canvas>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-4">
            <h2 class="mb-3">‚ö° Actions Rapides</h2>
            <div class="grid grid-3">
                <a href="/upload" class="action-card">
                    <div class="action-icon" style="background: var(--primary); color: white;">üì§</div>
                    <h3>Upload de Fichiers</h3>
                    <p>T√©l√©chargez vos fichiers CSV/JSON pour analyse</p>
                </a>

                <a href="http://localhost:5601/app/dashboards#/view/ecommerce-dashboard" target="_blank" class="action-card">
                    <div class="action-icon" style="background: #00bfb3; color: white;">üìä</div>
                    <h3>Dashboard Kibana</h3>
                    <p>Visualisez vos donn√©es en temps r√©el</p>
                </a>

                <a href="http://localhost:9200/_cat/indices?v" target="_blank" class="action-card">
                    <div class="action-icon" style="background: #f0b90b; color: white;">üîç</div>
                    <h3>Elasticsearch</h3>
                    <p>Explorez vos indices et recherchez</p>
                </a>
            </div>
        </div>

        <!-- Services Status -->
        <div class="card mt-4">
            <h2 class="mb-3">üîß Services Disponibles</h2>
            <div class="services-grid">
                <a href="http://localhost:9200" target="_blank" class="service-card">
                    <div class="service-icon" style="background: #f0b90b;">ES</div>
                    <div class="service-title">Elasticsearch</div>
                    <div class="service-desc">Moteur de recherche</div>
                    <div class="service-url">‚Üí :9200</div>
                </a>

                <a href="http://localhost:5601" target="_blank" class="service-card">
                    <div class="service-icon" style="background: #00bfb3;">Ki</div>
                    <div class="service-title">Kibana</div>
                    <div class="service-desc">Visualisation</div>
                    <div class="service-url">‚Üí :5601</div>
                </a>

                <a href="http://localhost:8081" target="_blank" class="service-card">
                    <div class="service-icon" style="background: #00ed64;">M</div>
                    <div class="service-title">MongoDB</div>
                    <div class="service-desc">Base de donn√©es</div>
                    <div class="service-url">‚Üí :8081</div>
                </a>

                <div class="service-card">
                    <div class="service-icon" style="background: #d82c20;">R</div>
                    <div class="service-title">Redis</div>
                    <div class="service-desc">Cache</div>
                    <div class="service-url">‚Üí :6379</div>
                </div>

                <div class="service-card">
                    <div class="service-icon" style="background: #005571;">L</div>
                    <div class="service-title">Logstash</div>
                    <div class="service-desc">Pipeline</div>
                    <div class="service-url">‚Üí :5044</div>
                </div>

                <a href="/upload" class="service-card">
                    <div class="service-icon" style="background: #2563eb;">F</div>
                    <div class="service-title">Flask</div>
                    <div class="service-desc">API Web</div>
                    <div class="service-url">‚Üí :8000</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© 2025 Monitoring SaaS - ELK Stack | Dashboard en temps r√©el</p>
        <p class="text-muted mt-1">Elasticsearch ‚Ä¢ Logstash ‚Ä¢ Kibana ‚Ä¢ MongoDB ‚Ä¢ Redis ‚Ä¢ Flask</p>
    </footer>

    <style>
        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .action-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .action-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .action-card p {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin: 0;
        }
    </style>

    <script>
        let logsChart = null;

        // Fonction pour formater les nombres avec des espaces
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        // Fonction pour charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Mettre √† jour les KPIs
                document.getElementById('kpi-total-logs').textContent = formatNumber(data.total_logs);
                document.getElementById('kpi-logs-today').textContent = formatNumber(data.logs_today);
                document.getElementById('kpi-errors').textContent = formatNumber(data.errors);
                document.getElementById('kpi-files').textContent = formatNumber(data.files_uploaded);

                // Mettre √† jour le graphique
                updateChart(data.timeline);
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                // Afficher des valeurs par d√©faut en cas d'erreur
                document.getElementById('kpi-total-logs').textContent = '0';
                document.getElementById('kpi-logs-today').textContent = '0';
                document.getElementById('kpi-errors').textContent = '0';
                document.getElementById('kpi-files').textContent = '0';
            }
        }

        // Fonction pour cr√©er/mettre √† jour le graphique
        function updateChart(timeline) {
            const ctx = document.getElementById('logsChart').getContext('2d');
            
            const labels = timeline.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
            });
            
            const data = timeline.map(item => item.count);

            if (logsChart) {
                // Mettre √† jour le graphique existant
                logsChart.data.labels = labels;
                logsChart.data.datasets[0].data = data;
                logsChart.update();
            } else {
                // Cr√©er un nouveau graphique
                logsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nombre de logs',
                            data: data,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#2563eb',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14,
                                        family: 'Inter'
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14,
                                    family: 'Inter'
                                },
                                bodyFont: {
                                    size: 13,
                                    family: 'Inter'
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Logs: ' + formatNumber(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    },
                                    callback: function(value) {
                                        return formatNumber(value);
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: 'Inter'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // Fonction pour rafra√Æchir les donn√©es
        function refreshData() {
            loadStats();
        }

        // Charger les statistiques au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            
            // Rafra√Æchir automatiquement toutes les 30 secondes
            setInterval(loadStats, 30000);
        });
    </script>
</body>
</html>
